
<!DOCTYPE html><html class=''>
<head>


<style class="cp-pen-styles">html, body{
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #101010;
}
.container{
    position: absolute;
    width: 500px;
    height: 500px;
    top: 50%;
    left: 50%;
    margin-top: -250px;
    margin-left: -250px;
}</style></head><body>
<div id="jsi-trump-container" class="container"></div></script><script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
<script>var RENDERER = {
	COUNT : 150,
	
	init : function(){
		this.setParameters();
		this.reconstructMethod();
		this.createDecks();
		this.render();
	},
	setParameters : function(){
		this.$window = $(window);
		this.$container = $('#jsi-trump-container');
		this.width = this.$container.width();
		this.height = this.$container.height();
		this.canvas = $('<canvas />').attr({width : this.width, height : this.height}).appendTo(this.$container).get(0);
		this.context = this.canvas.getContext('2d');
		this.theta = Math.PI / 2;
		this.deltaTheta = Math.PI / this.COUNT / 2;
		this.distance = Math.sqrt(Math.pow(this.width / 2, 2) + Math.pow(this.height / 2, 2));
		this.decks = [];
	},
	reconstructMethod : function(){
		this.render = this.render.bind(this);
	},
	createDecks : function(){
		this.decks.push(new DECK(this.width, this.height, this.width / 5, this.height / 5, 0, 0, this.COUNT));
		this.decks.push(new DECK(this.width, this.height, this.width * 4 / 5, this.height / 5, 1, 90, this.COUNT));
		this.decks.push(new DECK(this.width, this.height, this.width * 4 / 5, this.height * 4 / 5, 2, 180, this.COUNT));
		this.decks.push(new DECK(this.width, this.height, this.width / 5, this.height * 4 / 5, 3, 270, this.COUNT));
	},
	render : function(){
		requestAnimationFrame(this.render);
		
		var gradient = this.context.createRadialGradient(this.width / 2, this.height / 2, 0, this.width / 2, this.height / 2, this.distance);
		gradient.addColorStop(0, 'hsl(200, 30%, ' + (25 + 20 * Math.sin(this.theta)) + '%)');
		gradient.addColorStop(1, 'hsl(200, 30%, 5%)');
		this.context.fillStyle = gradient;
		this.context.fillRect(0, 0, this.width, this.height);
		
		for(var i = 0, length = this.decks.length; i < length; i++){
			this.decks[i].renderCard(this.context);
		}
		for(var i = 0, length = this.decks.length; i < length; i++){
			this.decks[i].render(this.context);
		}
		this.theta += this.deltaTheta;
		this.theta %= Math.PI * 2;
	}
};
var DECK = function(width, height, x, y, index, hue, totalMoveCount){
	this.width = width;
	this.height = height;
	this.x = x;
	this.y = y;
	this.index = index;
	this.hue = hue;
	this.totalMoveCount = totalMoveCount;
	this.init();
};
DECK.prototype = {
	JOINT_COUNT : 40,
	CHANGE_COUNT : 2,
	
	init : function(){
		this.arm = new JOINT(this.x, this.y, this.hue, this.JOINT_COUNT - 1);
		this.mark = new MARK(this.width, this.height, this.hue, false, this.index);
		var marks = [];
		
		for(var i = 0; i < 2; i++){
			marks.push(new MARK(this.width, this.height, this.hue, true, this.index));
		}
		this.card = new CARD(this.x, this.y, marks);
		this.isHit = false;
		this.limit = this.JOINT_COUNT;
		this.jointCount = this.JOINT_COUNT * this.CHANGE_COUNT;
		this.x = 0;
		this.y = 0;
		this.dx = this.width * 3 / 10 / this.totalMoveCount;
		this.dy = this.height * 3 / 10 / this.totalMoveCount;
		this.moveCount = this.totalMoveCount;
	},
	judgeToHit : function(){
		if(this.limit == this.JOINT_COUNT){
			this.isHit = false;
			return;
		}
		this.markAxis = this.mark.getAxis();
		
		var armAxis = this.arm.getAxis(this.limit),
			dx = this.markAxis.x - this.x - armAxis.x,
			dy = this.markAxis.y - this.y - armAxis.y;
			
		this.isHit = dx * dx + dy * dy <= this.mark.RADIUS * this.mark.RADIUS;
	},
	controlPosition : function(){
		switch(this.index){
		case 0:
			this.x += this.dx;
			break;
		case 1:
			this.y += this.dy;
			break;
		case 2:
			this.x -= this.dx;
			break;
		case 3:
			this.y -= this.dy;
			break;
		}
		if(--this.moveCount == 0){
			this.moveCount = this.totalMoveCount;
			
			if(++this.index == 4){
				this.index = 0;
			}
		}
	},
	renderCard : function(context){
		this.judgeToHit();
		context.save();
		context.translate(this.x, this.y);
		this.card.render(context, this.isHit);
		context.restore();
	},
	render : function(context){
		this.arm.follow(this.markAxis, this.limit, this.x, this.y);
		this.arm.adjust(this.limit, this.x, this.y);
		
		context.save();
		context.translate(this.x, this.y);
		this.arm.render(context, this.limit, this.isHit);
		context.restore();
		this.mark.render(context, this.isHit);
		
		if(this.jointCount > 0){
			this.limit = --this.jointCount / this.CHANGE_COUNT | 0;
		}
		this.controlPosition();
	}
};
var CARD = function(x, y, marks){
	this.x = x;
	this.y = y;
	this.marks = marks;
	this.init();
};
CARD.prototype = {
	SPECIAL : {1 : 'A', 11 : 'J', 12 : 'Q', 13 : 'K'},
	WIDTH : 80,
	HEIGHT : 120,
	
	init : function(){
		this.marks[0].setPosition(this.x - this.WIDTH / 2 + 10, this.y - this.HEIGHT / 2 + 30, false);
		this.marks[1].setPosition(this.x + this.WIDTH / 2 - 10, this.y + this.HEIGHT / 2 - 30, true);
		this.isHit = false;
		this.count = 1;
	},
	render : function(context, isHit){
		var gradient = context.createRadialGradient(this.x, this.y, 0, this.x, this.y, Math.sqrt(this.WIDTH * this.WIDTH + this.HEIGHT * this.HEIGHT));
		gradient.addColorStop(0, 'hsl(0, 0%, 100%)');
		gradient.addColorStop(1, 'hsl(0, 0%, 20%)');
		
		context.fillStyle = gradient;
		context.fillRect(this.x - this.WIDTH / 2, this.y - this.HEIGHT / 2, this.WIDTH, this.HEIGHT);
		
		for(var i = 0, length = this.marks.length; i < length; i++){
			this.marks[i].render(context, isHit);
		}
		context.fillStyle = '#000000';
		context.font = '900 16px "HG正楷書体-PRO"';
		context.textAlign = 'center';
		context.textBaseline = 'middle';
		
		var count = this.SPECIAL[this.count] ? this.SPECIAL[this.count] : this.count;
		context.save();
		context.translate(this.x - 30, this.y - 50);
		context.fillText(count, 0, 0);
		context.restore();
		context.save();
		context.translate(this.x + 30, this.y + 50);
		context.rotate(Math.PI);
		context.fillText(count, 0, 0);
		context.restore();
		
		if(isHit && !this.isHit){
			if(++this.count > 13){
				this.count = 1;
			}
		}
		this.isHit = isHit;
	}
};
var JOINT = function(x, y, hue, level){
	this.x = x;
	this.y = y;
	this.hue = hue;
	this.level = level;
	this.init();
};
JOINT.prototype = {
	WIDTH : 5,
	HEIGHT : 5,
	
	init : function(){
		this.setParameters();
		this.createJoint();
	},
	setParameters : function(){
		this.angle = Math.PI / 2;
		this.joint = null;
	},
	createJoint : function(){
		if(this.level == 0){
			return;
		}
		var axis = this.getTailAxis();
		this.joint = new JOINT(axis.x, axis.y, this.hue, this.level - 1);
	},
	follow : function(axis, limit, x, y){
		if(this.level < limit){
			return;
		}else if(this.level > limit){
			axis = this.joint.follow(axis, limit, x, y);
		}
		this.angle = Math.atan2(axis.y - (this.y + y), axis.x - (this.x + x));
		
		var tailAxis = this.getTailAxis();
		return {x : axis.x - (tailAxis.x - this.x), y : axis.y - (tailAxis.y - this.y)};
	},
	adjust : function(limit){
		if(this.joint == null){
			return;
		}
		this.joint.setHeadAxis(this.getTailAxis());
		this.joint.adjust(limit);
	},
	getAxis : function(limit){
		if(this.level == limit){
			return this.getTailAxis();
		}
		return this.joint.getAxis(limit);
	},
	setHeadAxis : function(axis){
		this.x = axis.x;
		this.y = axis.y;
	},
	getTailAxis : function(){
		return {x : this.x + this.WIDTH * Math.cos(this.angle), y : this.y + this.WIDTH * Math.sin(this.angle)};
	},
	render : function(context, limit, isHit){
		if(this.level < limit){
			return;
		}
		context.save();
		context.translate(this.x, this.y);
		context.rotate(this.angle);
		context.strokeStyle = 'hsl(' + this.hue + ', 50%, ' + (isHit ? 80 : 40) + '%)';
		context.fillStyle = 'hsl(' + this.hue + ', 50%, ' + (isHit ? 40 : 20) + '%)';
		context.beginPath();
		
		if(this.level == limit){
			context.arc(0, 0, this.HEIGHT * 2, Math.PI / 2, Math.PI * 3 / 2, false);
			context.lineTo(this.WIDTH * 2, -this.HEIGHT * 2);
			context.arc(this.WIDTH * 2, -this.HEIGHT * 3 / 2, this.HEIGHT / 2, -Math.PI / 2, Math.PI / 2, false);
			context.lineTo(this.WIDTH, -this.HEIGHT);
			context.lineTo(this.WIDTH, this.HEIGHT);
			context.lineTo(this.WIDTH * 2, this.HIGHET);
			context.arc(this.WIDTH * 2, this.HEIGHT * 3 / 2, this.HEIGHT / 2, -Math.PI / 2, Math.PI / 2, false);
		}else{
			context.arc(0, 0, this.HEIGHT / 2, Math.PI / 2, Math.PI * 3 / 2, false);
			context.lineTo(this.WIDTH, -this.HEIGHT / 2);
			context.arc(this.WIDTH, 0, this.HEIGHT / 2, -Math.PI / 2, Math.PI / 2, false);
		}
		context.closePath();
		context.fill();
		context.stroke();
		context.restore();
		
		if(this.joint){
			this.joint.render(context, limit, isHit);
		}
	}
};
var MARK = function(width, height, hue, isFixed, index){
	this.width = width;
	this.height = height;
	this.hue = hue;
	this.isFixed = isFixed;
	this.index = index;
	this.init();
};
MARK.prototype = {
	RADIUS : 30,
	VELOCITY : 5,
	
	init : function(){
		this.setParameters();
		this.setupPattern();
	},
	setParameters : function(){
		this.x = Math.random() * this.width;
		this.y = Math.random() * this.height;
		var angle = Math.random() * Math.PI * 2;
		this.vx = this.VELOCITY * Math.cos(angle);
		this.vy = this.VELOCITY * Math.sin(angle);
		this.theta = 0;
		this.isHit = false;
		this.pattern = [];
	},
	setupPattern : function(){
		this.pattern.push(this.renderHeart.bind(this));
		this.pattern.push(this.renderSpade.bind(this));
		this.pattern.push(this.renderClover.bind(this));
		this.pattern.push(this.renderDiamond.bind(this));
	},
	setPosition : function(x, y, isReversed){
		this.x = x;
		this.y = y;
		this.isReversed = isReversed;
	},
	getAxis : function(){
		return {x : this.x, y : this.y};
	},
	render : function(context, isHit){
		context.save();
		
		if(this.isFixed){
			context.translate(this.x, this.y);
			context.scale(0.3, 0.3);
			
			if(this.isReversed){
				context.rotate(Math.PI);
			}
		}else{
			if(isHit){
				context.shadowBlur = 30;
				context.shadowColor = 'hsl(' + this.hue + ', 50%, 50%)';
			}
			context.translate(this.x, this.y);
			context.rotate(this.theta);
		}
		context.beginPath();
		var gradient = context.createRadialGradient(0, 0, 0, 0, 0, this.RADIUS);
		gradient.addColorStop(0 ,'hsl(' + this.hue + ', 50%, ' + (isHit ? 80 : 40) + '%)');
		gradient.addColorStop(0.5 ,'hsl(' + this.hue + ', 50%, ' + (isHit ? 60 : 30) + '%)');
		gradient.addColorStop(1 ,'hsl(' + this.hue + ', 50%, ' + (isHit ? 40 : 20) + '%)');
		context.fillStyle = gradient;
		this.pattern[this.index](context);
		context.fill();
		context.restore();
		
		if(this.isFixed){
			return;
		}
		this.x += this.vx;
		this.y += this.vy;
		
		if(this.x < this.RADIUS && this.vx < 0 || this.x > this.width - this.RADIUS && this.vx > 0){
			this.vx *= -1;
		}
		if(this.y < this.RADIUS && this.vy < 0 || this.y > this.height - this.RADIUS && this.vy > 0){
			this.vy *= -1;
		}
		if(isHit){
			if(!this.isHit){
				var angle = Math.atan2(this.vy, this.vx) + (1 - 2 * Math.random()) * Math.PI / 3;
				this.vx = this.VELOCITY * Math.cos(angle);
				this.vy = this.VELOCITY * Math.sin(angle);
			}
		}else{
			this.theta += Math.PI / 100;
			this.theta %= Math.PI * 2;
		}
		this.isHit = isHit;
	},
	renderSpade : function(context){
		context.moveTo(0, -this.RADIUS);
		context.bezierCurveTo(this.RADIUS * 1.5, 0, this.RADIUS / 2, this.RADIUS, this.RADIUS / 8, this.RADIUS / 4);
		context.lineTo(this.RADIUS / 4, this.RADIUS);
		context.lineTo(-this.RADIUS / 4, this.RADIUS);
		context.lineTo(-this.RADIUS / 8, this.RADIUS / 4);
		context.bezierCurveTo(-this.RADIUS / 2, this.RADIUS, -this.RADIUS * 1.5, 0, 0, -this.RADIUS);
	},
	renderHeart : function(context){
		context.moveTo(0, this.RADIUS);
		context.bezierCurveTo(-this.RADIUS * 1.8, 0, -this.RADIUS / 2, -this.RADIUS, 0, -this.RADIUS / 4);
		context.bezierCurveTo(this.RADIUS / 2, -this.RADIUS, this.RADIUS * 1.8, 0, 0, this.RADIUS);
	},
	renderClover : function(context){
		context.moveTo(-this.RADIUS / 4, 0);
		context.bezierCurveTo(-this.RADIUS * 2 / 3, -this.RADIUS, this.RADIUS * 2 / 3, -this.RADIUS, this.RADIUS / 4, 0);
		context.bezierCurveTo(this.RADIUS * 5 / 4, -this.RADIUS * 5 / 12, this.RADIUS * 5 / 4, this.RADIUS * 11 / 12, this.RADIUS / 4, this.RADIUS / 2);
		context.lineTo(this.RADIUS / 8, this.RADIUS / 3);
		context.lineTo(this.RADIUS / 4, this.RADIUS);
		context.lineTo(-this.RADIUS / 4, this.RADIUS);
		context.lineTo(-this.RADIUS / 8, this.RADIUS / 3);
		context.lineTo(-this.RADIUS / 4, this.RADIUS / 2);
		context.bezierCurveTo(-this.RADIUS * 5 / 4, this.RADIUS * 11 / 12, -this.RADIUS * 5 / 4, -this.RADIUS * 5 / 12, -this.RADIUS / 4, 0);
	},
	renderDiamond : function(context){
		context.moveTo(0, -this.RADIUS);
		context.lineTo(this.RADIUS * 2 / 3, 0);
		context.lineTo(0, this.RADIUS);
		context.lineTo(-this.RADIUS * 2 / 3, 0);
		context.closePath();
	}
};
$(function(){
	RENDERER.init();
});
//# sourceURL=pen.js
</script>
</body></html>
